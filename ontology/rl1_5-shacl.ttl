# =============================================================================
# RL1.5 SHACL Shapes
# Version: 0.2
# Date: 2026-02-03
# =============================================================================
# Validation shapes for RL1.5 policies.
# =============================================================================

@prefix rl15:    <https://vocabulary.bigbank/rl1.5/> .
@prefix rl15sh:  <https://vocabulary.bigbank/rl1.5/shapes/> .
@prefix odrl:    <http://www.w3.org/ns/odrl/2/> .
@prefix sh:      <http://www.w3.org/ns/shacl#> .
@prefix xsd:     <http://www.w3.org/2001/XMLSchema#> .
@prefix rdf:     <http://www.w3.org/1999/02/22-rdf-syntax-ns#> .
@prefix rdfs:    <http://www.w3.org/2000/01/rdf-schema#> .

# =============================================================================
# POLICY SHAPES
# =============================================================================

rl15sh:PolicyShape a sh:NodeShape ;
    sh:targetClass rl15:Policy ;
    sh:name "Policy Shape" ;
    
    sh:property [
        sh:path rl15:clause ;
        sh:minCount 1 ;
        sh:message "Policy must have at least one clause."
    ] ;
    
    sh:property [
        sh:path rl15:condition ;
        sh:maxCount 1 ;
        sh:node rl15sh:ConditionShape
    ] ;
    
    sh:property [
        sh:path rl15:target ;
        sh:class rl15:Asset
    ] .

rl15sh:SetShape a sh:NodeShape ;
    sh:targetClass rl15:Set ;
    sh:name "Set Shape" ;
    
    # Set should NOT have grantor/grantee
    sh:property [
        sh:path rl15:grantor ;
        sh:maxCount 0 ;
        sh:message "Set should not have grantor. Use Offer or Agreement."
    ] ;
    
    sh:property [
        sh:path rl15:grantee ;
        sh:maxCount 0 ;
        sh:message "Set should not have grantee. Use Offer or Agreement."
    ] .

rl15sh:OfferShape a sh:NodeShape ;
    sh:targetClass rl15:Offer ;
    sh:name "Offer Shape" ;
    
    # Offer requires grantor
    sh:property [
        sh:path rl15:grantor ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:Agent ;
        sh:message "Offer must have exactly one grantor."
    ] ;
    
    # Grantee optional (open offer)
    sh:property [
        sh:path rl15:grantee ;
        sh:maxCount 1 ;
        sh:class rl15:Agent
    ] .

rl15sh:AgreementShape a sh:NodeShape ;
    sh:targetClass rl15:Agreement ;
    sh:name "Agreement Shape" ;
    
    sh:property [
        sh:path rl15:grantor ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:Agent ;
        sh:message "Agreement must have exactly one grantor."
    ] ;
    
    sh:property [
        sh:path rl15:grantee ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:Agent ;
        sh:message "Agreement must have exactly one grantee."
    ] .

# =============================================================================
# NORM SHAPES
# =============================================================================

rl15sh:NormShape a sh:NodeShape ;
    sh:targetClass rl15:Norm ;
    sh:name "Norm Shape" ;
    
    sh:property [
        sh:path rl15:subject ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:Agent ;
        sh:message "Norm must have exactly one subject."
    ] ;
    
    sh:property [
        sh:path rl15:action ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:Action ;
        sh:message "Norm must have exactly one action."
    ] ;
    
    sh:property [
        sh:path rl15:object ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:Asset ;
        sh:message "Norm must have exactly one object."
    ] ;
    
    sh:property [
        sh:path rl15:condition ;
        sh:maxCount 1 ;
        sh:node rl15sh:ConditionShape
    ] .

rl15sh:DutyShape a sh:NodeShape ;
    sh:targetClass rl15:Duty ;
    sh:name "Duty Shape" ;
    
    sh:property [
        sh:path rl15:deadline ;
        sh:maxCount 1 ;
        sh:or (
            [ sh:datatype xsd:dateTime ]
            [ sh:datatype xsd:duration ]
        ) ;
        sh:message "Deadline must be xsd:dateTime or xsd:duration."
    ] ;
    
    sh:property [
        sh:path rl15:dutyState ;
        sh:maxCount 1 ;
        sh:in (rl15:Pending rl15:Active rl15:Fulfilled rl15:Violated) ;
        sh:message "Duty state must be Pending, Active, Fulfilled, or Violated."
    ] .

# =============================================================================
# CONDITION SHAPES
# =============================================================================

rl15sh:ConditionShape a sh:NodeShape ;
    sh:name "Condition Shape" ;
    
    sh:or (
        [ sh:class rl15:AtomicConstraint ]
        [ sh:class rl15:LogicalConstraint ]
    ) ;
    sh:message "Condition must be AtomicConstraint or LogicalConstraint." .

rl15sh:AtomicConstraintShape a sh:NodeShape ;
    sh:targetClass rl15:AtomicConstraint ;
    sh:name "Atomic Constraint Shape" ;
    
    sh:property [
        sh:path rl15:leftOperand ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:LeftOperand ;
        sh:message "AtomicConstraint must have exactly one leftOperand."
    ] ;
    
    sh:property [
        sh:path rl15:constraintOperator ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:ComparisonOperator ;
        sh:message "AtomicConstraint must have exactly one comparison operator."
    ] ;
    
    # Must have rightOperand OR rightOperandRef
    sh:xone (
        [ sh:property [ sh:path rl15:rightOperand ; sh:minCount 1 ] ]
        [ sh:property [ sh:path rl15:rightOperandRef ; sh:minCount 1 ] ]
    ) ;
    sh:message "AtomicConstraint must have exactly one of: rightOperand or rightOperandRef." .

rl15sh:LogicalConstraintShape a sh:NodeShape ;
    sh:targetClass rl15:LogicalConstraint ;
    sh:name "Logical Constraint Shape" ;
    
    sh:property [
        sh:path rl15:constraintOperator ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:class rl15:LogicalOperator ;
        sh:message "LogicalConstraint must have exactly one logical operator."
    ] ;
    
    sh:property [
        sh:path rl15:operand ;
        sh:minCount 1 ;
        sh:node rl15sh:ConditionShape ;
        sh:message "LogicalConstraint must have at least one operand."
    ] .

rl15sh:NotConstraintShape a sh:NodeShape ;
    sh:target [
        a sh:SPARQLTarget ;
        sh:select """
            PREFIX rl15: <https://vocabulary.bigbank/rl1.5/>
            SELECT ?this WHERE {
                ?this a rl15:LogicalConstraint ;
                      rl15:constraintOperator rl15:not .
            }
        """
    ] ;
    sh:name "Not Constraint Shape" ;
    
    sh:property [
        sh:path rl15:operand ;
        sh:minCount 1 ;
        sh:maxCount 1 ;
        sh:message "Not constraint must have exactly one operand."
    ] .

# =============================================================================
# REJECT UNSUPPORTED CONSTRUCTS
# =============================================================================

rl15sh:RejectXoneShape a sh:NodeShape ;
    sh:target [
        a sh:SPARQLTarget ;
        sh:select """
            PREFIX rl15: <https://vocabulary.bigbank/rl1.5/>
            PREFIX odrl: <http://www.w3.org/ns/odrl/2/>
            SELECT ?this WHERE {
                { ?this rl15:constraintOperator rl15:xone }
                UNION
                { ?this odrl:operator odrl:xone }
            }
        """
    ] ;
    sh:severity sh:Violation ;
    sh:message "RL1.5 does not support xone operator." .

# =============================================================================
# END OF SHAPES
# =============================================================================
